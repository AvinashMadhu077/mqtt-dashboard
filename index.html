<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Air Quality Monitoring Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b1220;
  color: #e5e7eb;
}
.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
.card {
  background: #1b2435;
  border-radius: 16px;
  padding: 18px;
  margin-bottom: 14px;
}
.sensor {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.value {
  font-size: 28px;
  font-weight: bold;
}
.badge {
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: bold;
}
.good { background:#22c55e; }
.warn { background:#f59e0b; }
.bad  { background:#ef4444; }

button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  color: white;
}
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <h2 style="text-align:center;margin:0">Air Quality Dashboard</h2>
  </div>

  <div class="card">
    <button id="alertToggle" style="background:#6b7280">ðŸ”• Alerts OFF</button>
  </div>

  <div class="card sensor">
    <div>PM2.5</div>
    <div class="value"><span id="pm25">--</span></div>
  </div>

  <div class="card sensor">
    <div>COâ‚‚</div>
    <div class="value"><span id="co2">--</span></div>
  </div>

  <div class="card sensor">
    <div>CO</div>
    <div class="value"><span id="co">--</span></div>
  </div>

  <div class="card sensor">
    <div>Temperature</div>
    <div class="value"><span id="temp">--</span></div>
  </div>

  <div class="card sensor">
    <div>Humidity</div>
    <div class="value"><span id="hum">--</span></div>
  </div>

  <div class="card sensor">
    <div>Overall AQI</div>
    <div class="value"><span id="aqi">--</span></div>
  </div>

</div>

<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script>
/* ===== MQTT ===== */
const client = mqtt.connect(
  "wss://cd29a7c955164a079ab779cab2f382d7.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username: "adam1234",
    password: "Adam1234",
    reconnectPeriod: 3000
  }
);

client.on("connect", () => {
  client.subscribe("esp32/sensor");
});

/* ===== ALERT SYSTEM ===== */
let alertsEnabled = false;
let alertPlaying = false;

const alertSound = document.getElementById("alertSound");
const toggleBtn = document.getElementById("alertToggle");

toggleBtn.addEventListener("click", () => {
  alertsEnabled = !alertsEnabled;

  if (alertsEnabled) {
    toggleBtn.textContent = "ðŸ”” Alerts ON";
    toggleBtn.style.background = "#22c55e";

    // unlock audio for iOS
    alertSound.play().then(() => {
      alertSound.pause();
      alertSound.currentTime = 0;
    }).catch(() => {});
  } else {
    toggleBtn.textContent = "ðŸ”• Alerts OFF";
    toggleBtn.style.background = "#6b7280";
    alertSound.pause();
    alertSound.currentTime = 0;
    alertPlaying = false;
  }
});

function checkDanger(data) {
  if (!alertsEnabled) return;

  const pm25 = Number(data.pm25) || 0;
  const co   = Number(data.co)   || 0;
  const temp = Number(data.temp) || 0;
  const co2  = Number(data.co2)  || 0;
  const hum  = Number(data.hum)  || 0;

  const danger =
    pm25 > 40 ||
    co > 40 ||
    temp > 40 ||
    co2 > 80 ||
    hum > 80;

  if (danger && !alertPlaying) {
    alertPlaying = true;
    alertSound.loop = true;
    alertSound.play().catch(()=>{});
  }

  if (!danger && alertPlaying) {
    alertSound.pause();
    alertSound.currentTime = 0;
    alertPlaying = false;
  }
}

/* ===== MQTT DATA ===== */
client.on("message", (topic, msg) => {
  const data = JSON.parse(msg.toString());

  pm25.textContent = Number(data.pm25) || 0;
  co2.textContent  = Number(data.co2)  || 0;
  co.textContent   = Number(data.co)   || 0;
  temp.textContent = Number(data.temp) || 0;
  hum.textContent  = Number(data.hum)  || 0;

  aqi.textContent = Math.max(
    Number(data.pm25) || 0,
    (Number(data.co2) || 0) / 10,
    (Number(data.co) || 0) * 5
  ).toFixed(0);

  checkDanger(data);
});
</script>

</body>
</html>
