<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Air Quality Monitoring Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b1220;
  color: #e5e7eb;
}

.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}

.card {
  background: #1b2435;
  border-radius: 16px;
  padding: 18px;
  margin-bottom: 14px;
}

.sensor {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.value {
  font-size: 28px;
  font-weight: bold;
}

button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  color: white;
}

/* ===== PM2.5 VISUAL ===== */
.pm-box {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.pm-info {
  z-index: 2;
}

.pm-dots {
  position: relative;
  width: 120px;
  height: 80px;
  overflow: hidden;
}

.dot {
  position: absolute;
  background: #fbbf24;
  border-radius: 50%;
  opacity: 0.8;
}
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <h2 style="text-align:center;margin:0">Air Quality Dashboard</h2>
  </div>

  <div class="card">
    <button id="alertToggle" style="background:#6b7280">ðŸ”• Alerts OFF</button>
  </div>

  <!-- PM2.5 CUSTOM DESIGN -->
  <div class="card pm-box">
    <div class="pm-info">
      <div style="opacity:0.8">PM2.5</div>
      <div class="value"><span id="pm25">--</span> Âµg/mÂ³</div>
    </div>
    <div class="pm-dots" id="pmDots"></div>
  </div>

  <div class="card sensor">
    <div>COâ‚‚</div>
    <div class="value"><span id="co2">--</span></div>
  </div>

  <div class="card sensor">
    <div>CO</div>
    <div class="value"><span id="co">--</span></div>
  </div>

  <div class="card sensor">
    <div>Temperature</div>
    <div class="value"><span id="temp">--</span></div>
  </div>

  <div class="card sensor">
    <div>Humidity</div>
    <div class="value"><span id="hum">--</span></div>
  </div>

  <div class="card sensor">
    <div>Overall AQI</div>
    <div class="value"><span id="aqi">--</span></div>
  </div>

</div>

<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script>
/* ===== MQTT ===== */
const client = mqtt.connect(
  "wss://cd29a7c955164a079ab779cab2f382d7.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username: "adam1234",
    password: "Adam1234"
  }
);

client.on("connect", () => {
  client.subscribe("esp32/sensor");
});

/* ===== PM2.5 DOT GENERATOR ===== */
function renderPMDots(pm) {
  const box = document.getElementById("pmDots");
  box.innerHTML = "";

  const count = Math.min(120, Math.floor(pm * 2)); // density control

  for (let i = 0; i < count; i++) {
    const d = document.createElement("div");
    const size = Math.random() * 6 + 2;

    d.className = "dot";
    d.style.width = size + "px";
    d.style.height = size + "px";
    d.style.left = Math.random() * 120 + "px";
    d.style.top = Math.random() * 80 + "px";
    d.style.opacity = Math.random();

    box.appendChild(d);
  }
}

/* ===== ALERT TOGGLE ===== */
let alertsEnabled = false;
let alertPlaying = false;

const alertSound = document.getElementById("alertSound");
const toggleBtn = document.getElementById("alertToggle");

toggleBtn.onclick = () => {
  alertsEnabled = !alertsEnabled;
  toggleBtn.textContent = alertsEnabled ? "ðŸ”” Alerts ON" : "ðŸ”• Alerts OFF";
  toggleBtn.style.background = alertsEnabled ? "#22c55e" : "#6b7280";

  if (alertsEnabled) {
    alertSound.play().then(()=> {
      alertSound.pause();
      alertSound.currentTime = 0;
    }).catch(()=>{});
  } else {
    alertSound.pause();
    alertPlaying = false;
  }
};

function checkDanger(data) {
  if (!alertsEnabled) return;

  const danger =
    data.pm25 > 40 ||
    data.co > 40 ||
    data.temp > 40 ||
    data.co2 > 80 ||
    data.hum > 80;

  if (danger && !alertPlaying) {
    alertPlaying = true;
    alertSound.loop = true;
    alertSound.play().catch(()=>{});
  }

  if (!danger && alertPlaying) {
    alertSound.pause();
    alertPlaying = false;
  }
}

/* ===== MQTT DATA ===== */
client.on("message", (topic, msg) => {
  const data = JSON.parse(msg.toString());

  pm25.textContent = data.pm25 || 0;
  co2.textContent  = data.co2 || 0;
  co.textContent   = data.co || 0;
  temp.textContent = data.temp || 0;
  hum.textContent  = data.hum || 0;

  aqi.textContent = Math.max(
    data.pm25 || 0,
    (data.co2 || 0) / 10
  ).toFixed(0);

  renderPMDots(data.pm25 || 0);
  checkDanger(data);
});
</script>

</body>
</html>
