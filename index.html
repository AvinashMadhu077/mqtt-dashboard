<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Air Quality Monitoring Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
:root {
  --bg: #0b1220;
  --card: #1b2435;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --green: #22c55e;
  --yellow: #f59e0b;
  --red: #ef4444;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
  background: radial-gradient(circle at top, #111827, #020617);
  color: var(--text);
}

.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}

.card {
  background: var(--card);
  border-radius: 18px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 15px 40px rgba(0,0,0,.4);
}

.title {
  text-align: center;
}

.title h1 {
  margin: 0;
  font-size: 26px;
}

.title p {
  color: var(--muted);
  margin-top: 6px;
}

.status-card {
  display: flex;
  align-items: center;
  gap: 10px;
}

.dot {
  width: 10px;
  height: 10px;
  background: var(--green);
  border-radius: 50%;
}

.sensor {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.value {
  font-size: 30px;
  font-weight: bold;
}

.unit {
  font-size: 18px;
  color: var(--muted);
}

.badge {
  padding: 6px 14px;
  border-radius: 999px;
  background: var(--green);
  font-size: 12px;
  font-weight: bold;
}

.badge.warn { background: var(--yellow); }
.badge.danger { background: var(--red); }

.sub {
  margin-top: 10px;
  color: var(--muted);
  font-size: 14px;
}

.raw {
  font-family: monospace;
  font-size: 13px;
  color: var(--muted);
  word-break: break-word;
}

footer {
  text-align: center;
  color: var(--muted);
  font-size: 13px;
  margin-top: 20px;
}

/* ALERT BUTTON */
#enableSoundBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 14px 20px;
  font-size: 16px;
  border-radius: 30px;
  border: none;
  background: var(--red);
  color: white;
  font-weight: 700;
  cursor: pointer;
  z-index: 9999;
}
</style>
</head>

<body>
<div class="container">

  <div class="card title">
    <h1>Air Quality Monitoring Dashboard</h1>
    <p>Real-time Environmental Monitoring System</p>
  </div>

  <div class="card status-card">
    <div class="dot"></div>
    <div>
      <strong id="mqttStatus">Connecting to MQTT Broker</strong><br>
      <span class="sub">Last Update: <span id="lastUpdate">--:--:--</span></span>
    </div>
  </div>

  <div class="card sensor">
    <div>
      <strong>PM2.5</strong>
      <div class="value"><span id="pm25">--</span> <span class="unit">Âµg/mÂ³</span></div>
    </div>
    <div class="badge">GOOD</div>
  </div>

  <div class="card sensor">
    <div>
      <strong>COâ‚‚</strong>
      <div class="value"><span id="co2">--</span> <span class="unit">ppm</span></div>
    </div>
    <div class="badge">GOOD</div>
  </div>

  <div class="card sensor">
    <div>
      <strong>CO</strong>
      <div class="value"><span id="co">--</span> <span class="unit">ppm</span></div>
    </div>
    <div class="badge">GOOD</div>
  </div>

  <div class="card sensor">
    <div>
      <strong>Temperature</strong>
      <div class="value"><span id="temp">--</span> <span class="unit">Â°C</span></div>
    </div>
    <div class="badge">NORMAL</div>
  </div>

  <div class="card sensor">
    <div>
      <strong>Humidity</strong>
      <div class="value"><span id="hum">--</span> <span class="unit">%</span></div>
    </div>
    <div class="badge">NORMAL</div>
  </div>

  <div class="card sensor">
    <div>
      <strong>Overall AQI</strong>
      <div class="value"><span id="aqi">--</span></div>
    </div>
    <div class="badge warn">MODERATE</div>
  </div>

  <div class="card">
    <strong>Raw Sensor Data Stream</strong>
    <div class="raw" id="raw">--</div>
  </div>

  <footer>
    Â© 2026 Air Quality Monitoring System | ESP32 & MQTT
  </footer>
</div>

<!-- ðŸ”Š ALERT -->
<button id="enableSoundBtn">ðŸ”Š Enable Alerts</button>
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script>
/* ===== MQTT ===== */
const client = mqtt.connect(
  "wss://cd29a7c955164a079ab779cab2f382d7.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username: "adam1234",
    password: "Adam1234",
    reconnectPeriod: 3000
  }
);

client.on("connect", () => {
  mqttStatus.innerText = "Connected to MQTT Broker";
  client.subscribe("esp32/sensor");
});

/* ===== ALERT SYSTEM ===== */
let soundEnabled = false;
let alertPlaying = false;

const alertSound = document.getElementById("alertSound");
const enableBtn = document.getElementById("enableSoundBtn");

enableBtn.addEventListener("click", () => {
  alertSound.play().then(() => {
    alertSound.pause();
    alertSound.currentTime = 0;
    soundEnabled = true;
    enableBtn.textContent = "ðŸ”” Alerts Enabled";
    enableBtn.style.background = "#22c55e";
  });
});

function checkDanger(data) {
  if (!soundEnabled) return;

  const danger =
    data.pm25 > 40 ||
    data.co > 40 ||
    data.temp > 40 ||
    data.co2 > 80;

  if (danger && !alertPlaying) {
    alertPlaying = true;
    alertSound.loop = true;
    alertSound.play();
  }

  if (!danger && alertPlaying) {
    alertSound.pause();
    alertSound.currentTime = 0;
    alertPlaying = false;
  }
}

/* ===== MQTT MESSAGE ===== */
client.on("message", (topic, msg) => {
  const data = JSON.parse(msg.toString());

  pm25.innerText = data.pm25;
  co2.innerText = data.co2;
  co.innerText = data.co;
  temp.innerText = data.temp;
  hum.innerText = data.hum;
  aqi.innerText = data.aqi;
  raw.innerText = msg.toString();
  lastUpdate.innerText = new Date().toLocaleTimeString();

  checkDanger(data);
});
</script>
</body>
</html>
