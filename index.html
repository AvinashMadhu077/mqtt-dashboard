<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air Quality Dashboard</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: white;
  margin: 0;
  padding: 20px;
}
.card {
  background: #1e293b;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 15px;
}
.value {
  font-size: 2rem;
  font-weight: bold;
}
#alertToggle {
  width: 100%;
  padding: 15px;
  font-size: 1.1rem;
  border: none;
  border-radius: 10px;
  background: #6b7280;
  color: white;
  cursor: pointer;
}
#alertToggle.on {
  background: #22c55e;
}
#alertToggle.off {
  background: #6b7280;
}
</style>
</head>

<body>

<h1>üåç Air Quality Monitoring</h1>

<button id="alertToggle" class="off">üîï Alerts OFF</button>

<div class="card">PM2.5: <span class="value" id="pm25">--</span></div>
<div class="card">CO2: <span class="value" id="co2">--</span></div>
<div class="card">CO: <span class="value" id="co">--</span></div>
<div class="card">Temperature: <span class="value" id="temp">--</span></div>
<div class="card">Humidity: <span class="value" id="hum">--</span></div>
<div class="card">AQI: <span class="value" id="aqi">--</span></div>

<div class="card">
  <b>Raw MQTT Data</b>
  <pre id="raw">--</pre>
</div>

<p id="status">Connecting to MQTT‚Ä¶</p>

<!-- üîä ALERT SOUND -->
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script>
/* ===== MQTT CONFIG ===== */
const MQTT_URL = "wss://cd29a7c955164a079ab779cab2f382d7.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_OPTIONS = {
  username: "adam1234",
  password: "Adam1234",
  reconnectPeriod: 3000
};

/* ===== ELEMENTS ===== */
const pm25 = document.getElementById("pm25");
const co2 = document.getElementById("co2");
const co = document.getElementById("co");
const temp = document.getElementById("temp");
const hum = document.getElementById("hum");
const aqi = document.getElementById("aqi");
const raw = document.getElementById("raw");
const status = document.getElementById("status");

const alertSound = document.getElementById("alertSound");
const alertToggle = document.getElementById("alertToggle");

/* ===== ALERT STATE ===== */
let alertsEnabled = false;
let alertPlaying = false;

/* ===== ALERT TOGGLE (iOS SAFE) ===== */
alertToggle.addEventListener("click", () => {
  alertsEnabled = !alertsEnabled;

  if (alertsEnabled) {
    alertToggle.textContent = "üîî Alerts ON";
    alertToggle.classList.remove("off");
    alertToggle.classList.add("on");

    // unlock audio for iOS
    alertSound.play().then(() => {
      alertSound.pause();
      alertSound.currentTime = 0;
    }).catch(() => {});
  } else {
    alertToggle.textContent = "üîï Alerts OFF";
    alertToggle.classList.remove("on");
    alertToggle.classList.add("off");

    alertSound.pause();
    alertSound.currentTime = 0;
    alertPlaying = false;
  }
});

/* ===== MQTT CONNECT ===== */
const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);

client.on("connect", () => {
  status.textContent = "‚úÖ Connected to HiveMQ";
  client.subscribe("esp32/sensor");
});

client.on("message", (topic, message) => {
  const data = JSON.parse(message.toString());

  pm25.textContent = data.pm25;
  co2.textContent = data.co2;
  co.textContent = data.co;
  temp.textContent = data.temp;
  hum.textContent = data.hum;
  aqi.textContent = data.aqi;
  raw.textContent = message.toString();

  checkDanger(data);
});

/* ===== DANGER CHECK ===== */
function checkDanger(data) {
  if (!alertsEnabled) return;

  const danger =
    data.pm25 > 40 ||
    data.co > 40 ||
    data.temp > 40 ||
    data.co2 > 80;

  if (danger && !alertPlaying) {
    alertPlaying = true;
    alertSound.loop = true;
    alertSound.play().catch(() => {});
  }

  if (!danger && alertPlaying) {
    alertSound.pause();
    alertSound.currentTime = 0;
    alertPlaying = false;
  }
}
</script>

</body>
</html>
