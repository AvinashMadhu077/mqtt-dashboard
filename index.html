<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dynamic Sensor OS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap" rel="stylesheet">

<style>
:root { --bg:#05080f; --text:#f8fafc; }
body { margin:0; font-family:Inter,sans-serif; background:var(--bg); color:var(--text); padding:20px; display:flex; justify-content:center; }
.container { width:100%; max-width:420px; }
.card { border-radius:32px; margin-bottom:20px; padding:25px; position:relative; overflow:hidden; height:220px; }
.label-row { display:flex; justify-content:space-between; align-items:center; }
.label { font-size:.75rem; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; opacity:.8; }
.status-tag { font-size:.7rem; font-weight:800; padding:4px 10px; border-radius:20px; }
.val { font-size:3.5rem; font-weight:900; margin:5px 0; line-height:1; }

.st-good{background:#dcfce7;color:#166534}
.st-avg{background:#fef3c7;color:#92400e}
.st-bad{background:#fee2e2;color:#991b1b}
.st-dark-good{background:#064e3b;color:#34d399}
.st-dark-avg{background:#78350f;color:#fbbf24}
.st-dark-bad{background:#7f1d1d;color:#f87171}

.pm-card{background:rgba(255,255,255,.95);color:#1e293b}
.co2-card{background:#1a102e}
.hum-card{background:#070b14}
.temp-card{background:#1e0a0a}
.co-card{background:#0f172a;border:1px solid #334155}

.notification{
  background:rgba(15,23,42,.95);
  color:white;
  padding:15px;
  border-radius:12px;
  border-left:4px solid #ef4444;
  transform:translateX(400px);
  transition:.5s;
}
.notification.show{transform:translateX(0)}
.notification-title{font-weight:700;font-size:.9rem;color:#f87171}
.notification-message{font-size:.8rem}
</style>
</head>

<body>
<div class="container">

<div class="card pm-card">
<div class="label-row"><div class="label">Particulates</div><div id="pmStatus" class="status-tag st-good">Good</div></div>
<div class="val" id="pmPerc">0%</div>
PM2.5 â€” <span id="pmVal">0</span>
<canvas id="pmCanvas" style="width:100%;height:120px"></canvas>
</div>

<div class="card co2-card">
<div class="label-row"><div class="label">COâ‚‚</div><div id="co2Status" class="status-tag st-dark-good">Good</div></div>
<div class="val" id="co2Val">0</div>
</div>

<div class="card hum-card">
<div class="label-row"><div class="label">Humidity</div><div id="humStatus" class="status-tag st-dark-good">Good</div></div>
<div class="val" id="humVal">0%</div>
</div>

<div class="card temp-card">
<div class="label-row"><div class="label">Temperature</div><div id="tempStatus" class="status-tag st-dark-good">Good</div></div>
<div class="val" id="tempVal">0Â°C</div>
</div>

<div class="card co-card">
<div class="label-row"><div class="label">CO</div><div id="coStatus" class="status-tag st-dark-good">Safe</div></div>
<div class="val" id="coVal">0 ppm</div>
</div>

</div>

<!-- ALERT TOGGLE -->
<div id="alertToggle" style="position:fixed;bottom:20px;right:20px">
<button style="padding:12px 24px;border-radius:50px;border:none;font-weight:600;cursor:pointer">
<span id="toggleText">ðŸ”‡ Alerts Off</span>
</button>
</div>

<!-- NOTIFICATIONS -->
<div id="notificationContainer" style="position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px"></div>

<!-- AUDIO -->
<audio id="alertSound" preload="auto" loop>
<source src="./alert.mp3" type="audio/mpeg">
</audio>

<script>
const client = mqtt.connect("wss://cd29a7c955164a079ab779cab2f382d7.s1.eu.hivemq.cloud:8884/mqtt",{
username:"adam1234",password:"Adam1234"
});
client.subscribe("esp32/sensor");

let alertsEnabled=false;
let activeAlerts=new Set();
const alertSound=document.getElementById("alertSound");
const toggleText=document.getElementById("toggleText");

const thresholds={pm:20,co2:80,humidity:80,temp:40};

document.getElementById("alertToggle").onclick=()=>{
alertsEnabled=!alertsEnabled;
if(alertsEnabled){
toggleText.textContent="ðŸ”Š Alerts On";

/* ðŸ”“ AUDIO UNLOCK (CRITICAL FIX) */
alertSound.muted=true;
alertSound.play().then(()=>{
alertSound.pause();
alertSound.currentTime=0;
alertSound.muted=false;
});
}else{
toggleText.textContent="ðŸ”‡ Alerts Off";
alertSound.pause();
alertSound.currentTime=0;
activeAlerts.clear();
document.getElementById("notificationContainer").innerHTML="";
}
};

function notify(sensor,text){
const id="n-"+sensor;
if(document.getElementById(id))return;
const n=document.createElement("div");
n.id=id;
n.className="notification";
n.innerHTML=`<div class="notification-title">${sensor.toUpperCase()} ALERT</div>
<div class="notification-message">${text}</div>`;
document.getElementById("notificationContainer").appendChild(n);
setTimeout(()=>n.classList.add("show"),10);
}

client.on("message",(t,m)=>{
const d=JSON.parse(m.toString());
if(!alertsEnabled)return;

let triggered=false;

if(d.pm25>thresholds.pm){notify("pm","PM2.5 too high");triggered=true;}
if(d.co2>thresholds.co2){notify("co2","COâ‚‚ too high");triggered=true;}
if(d.hum>thresholds.humidity){notify("humidity","Humidity too high");triggered=true;}
if(d.temp>thresholds.temp){notify("temp","Temperature too high");triggered=true;}

if(triggered){
if(alertSound.paused) alertSound.play();
}else{
alertSound.pause();
alertSound.currentTime=0;
}
});
</script>
</body>
</html>
